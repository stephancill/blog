<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.3.1">Jekyll</generator><link href="/feed.xml" rel="self" type="application/atom+xml" /><link href="/" rel="alternate" type="text/html" /><updated>2023-01-02T22:23:58+00:00</updated><id>/feed.xml</id><title type="html">Stephanâ€™s Blog</title><subtitle>The personal blog of Stephan (@stephancill). I'm an engineer interested in the intersection of decentralized technology and climate action.</subtitle><entry><title type="html">On-chain Solar Systems</title><link href="/projects/2023/01/02/onchain-solar-systems.html" rel="alternate" type="text/html" title="On-chain Solar Systems" /><published>2023-01-02T16:07:40+00:00</published><updated>2023-01-02T16:07:40+00:00</updated><id>/projects/2023/01/02/onchain-solar-systems</id><content type="html" xml:base="/projects/2023/01/02/onchain-solar-systems.html"><![CDATA[<h1 id="on-chain-solar-systems">On-chain Solar Systems</h1>

<p>Going into the festive season after our first month of working full time on <a href="https://onsetcarbon.com">Onset Carbon</a> - a challenging and fulfilling undertaking - <a href="https://twitter.com/npm_luko">Luke</a> and I wanted to scratch the itch of building and launching a complete product.</p>

<p>I have been seeing some interesting fully on-chain projects crop up on Twitter such as <a href="https://1337skulls.xyz">1337skulls</a>. Their commitment to unique thematic design and user experience inspired us to try and build something similar.</p>

<h2 id="idea">Idea</h2>

<p>For a project to be feasible to deploy on a blockchain, the size of the code being deployed has to be sufficiently small. This is why on-chain art projects often consist of simple shapes or pixel art. We wanted to build something that was was not too technical from an artistry perspective but still had a unique aesthetic and was small enough to deploy in a single transaction at a reasonable cost.</p>

<p>We explored a few ideas but ended up settling on procedurally generated SVG solar systems with animated orbits. The planets are simple circles animated to orbit around a circle star.</p>

<h2 id="implementation">Implementation</h2>

<h3 id="figma-design">Figma design</h3>

<p>The first step in the process is to decide what a Solar System will look like. We had a rough idea of what we envisioned and used Figma to create a design and then exported it as SVG.</p>

<p><img src="/assets/solar-systems/v1.jpg" alt="Original design" />
<em>Original design</em></p>

<h3 id="svg-simplification">SVG Simplification</h3>

<p>The next step was to identify repeated structure in the SVG and simplify the exported SVG down into minimal boilerplate which could be generated by a script. My preferred method for experimenting with SVG is by using <a href="https://editsvgcode.com/">editsvgcode.com</a> as it provides a nice real-time view of the result which lets you iterate quickly. It also makes it easy to branch off and try different ideas by having it open in multiple tabs. Ideally Iâ€™d like to have this running in Vscode but havenâ€™t found a good extension for it yet.</p>

<h3 id="animations">Animations</h3>

<p>This step also involved animating the orbits of the planets.
We ended up using the <code class="language-plaintext highlighter-rouge">&lt;animateTransform&gt;</code> tag to rotate the planets around the star.</p>

<pre><code class="language-svg">&lt;!-- Planet SVG --&gt;
&lt;g&gt;
  ...
  &lt;animateTransform
      attributeName="transform"
      type="rotate"
      from="0 ${halfCanvasWidth} ${halfCanvasWidth}"
      to="360 ${halfCanvasWidth} ${halfCanvasWidth}"
      dur="${duration}"
      repeatCount="indefinite"&gt;
  &lt;/animateTransform&gt;
&lt;/g&gt;
</code></pre>

<p>The <code class="language-plaintext highlighter-rouge">from</code> and <code class="language-plaintext highlighter-rouge">to</code> attributes are used to specify the starting and ending rotation angle. The <code class="language-plaintext highlighter-rouge">dur</code> attribute specifies the duration of the animation. The <code class="language-plaintext highlighter-rouge">repeatCount</code> attribute is used to specify how many times the animation should repeat. We set it to <code class="language-plaintext highlighter-rouge">indefinite</code> to make it repeat forever.</p>

<p><img src="/assets/solar-systems/sample.svg" alt="Animated design" />
<em>Animated design</em></p>

<!-- Limit width -->

<h3 id="javascript-prototype">JavaScript prototype</h3>

<p>Now that we had the base SVG and isolated the repeated components we could start building a script to generate the SVG. This was done in a simple file containing some HTML and JavaScript code which generates the SVG and displays it which can be found <a href="https://github.com/lbowles/solar-systems/blob/main/client/sample.html">here</a>.</p>

<p>We had to determine the variables that would be used to procedurally generate the SVG. We decided to make the following properties variable in each solar system:</p>

<ul>
  <li>Star color (yellow, blue)</li>
  <li>Star size</li>
  <li>Number of planets (1-5)</li>
  <li>Planet size</li>
  <li>Planet color</li>
  <li>Planet orbit period (5-14 seconds)</li>
</ul>

<p>We also wanted to give each planet a minimum brightness to ensure it was always visible against the background so the RGB color values always ranged from 100 to 255.</p>

<p>This implementation works fine for viewing on platforms that support animation but it doesnâ€™t work for static images because all the planets would start in a line, which looks a bit weird.</p>

<p><img src="/assets/solar-systems/static.jpg" alt="Static issue" />
<em>Static issue</em></p>

<p>To address this, we needed to randomize the starting position of the planets as well. This was done by adding a random angle to the starting position of the planet and then calculating the starting position from the initial position by using trigonometry to translate the angle into x and y coordinates:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">orbitRadius</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">angle</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">360</span><span class="p">;</span> <span class="c1">// Random in degrees</span>

<span class="kd">const</span> <span class="nx">newX</span> <span class="o">=</span>
  <span class="nx">x</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">angle</span> <span class="o">*</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">/</span> <span class="mi">180</span><span class="p">))</span> <span class="o">-</span> <span class="nx">y</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">angle</span> <span class="o">*</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">/</span> <span class="mi">180</span><span class="p">));</span>
<span class="kd">const</span> <span class="nx">newY</span> <span class="o">=</span>
  <span class="nx">x</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">angle</span> <span class="o">*</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">/</span> <span class="mi">180</span><span class="p">))</span> <span class="o">+</span> <span class="nx">y</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">angle</span> <span class="o">*</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">/</span> <span class="mi">180</span><span class="p">));</span>
</code></pre></div></div>

<h3 id="solidity">Solidity</h3>

<p>The JavaScript sample implementation was then ported to Solidity. The main differences include the lack of floating point numbers support, and a <code class="language-plaintext highlighter-rouge">Math.random()</code> equivalent.</p>

<p>We implemented some pseudorandomness using the token ID and some description string as entropy by taking a keccak hash of the concatenation of the two. This is not cryptographically secure but it is sufficient for our purposes. Here you can see how the <code class="language-plaintext highlighter-rouge">randomRange</code> function makes use of the <code class="language-plaintext highlighter-rouge">random</code> function to generate a random number in a given range.</p>

<pre><code class="language-solidity">function random(string memory input) internal pure returns (uint256) {
  return uint256(keccak256(abi.encodePacked(input)));
}

function randomRange(
  uint256 tokenId,
  string memory keyPrefix,
  uint256 lower,
  uint256 upper
) internal pure returns (uint256) {
  uint256 rand = random(string(abi.encodePacked(keyPrefix, uint2str(tokenId))));
  return (rand % (upper - lower)) + lower;
}
</code></pre>

<p>Here is an example of it in action to generate a random number from 5-14 for the duration of the orbit animation:</p>

<pre><code class="language-solidity">planet.duration = utils.randomRange(_tokenId, string.concat("duration", utils.uint2str(i)), 5, 15);
</code></pre>

<p>Function calls in Solidity canâ€™t take too many arguments so we had to split the <code class="language-plaintext highlighter-rouge">string.concat</code> function into multiple calls to generate the final SVG output string.</p>

<p>To get a hot reloading live view of the SVG being rendered by the contract for testing purposes, we used <a href="https://github.com/w1nt3r-eth/hot-chain-svg">hot-chain-svg</a>. This is a simple tool that watches a contract for changes and automatically compiles and deploys the contract and renders a sample token.</p>

<p>In the context of the NFT project, this rendering logic is contained in the <code class="language-plaintext highlighter-rouge">Renderer</code> contract which is called upon by the <code class="language-plaintext highlighter-rouge">SolarSystem.tokenURI</code> function to generate the SVG for a given token ID.</p>

<p>The <code class="language-plaintext highlighter-rouge">SolarSystem</code> contract inherits from <a href="https://github.com/chiru-labs/ERC721A">ERC721A</a> which is a gas-efficient implementation of the <a href="https://eips.ethereum.org/EIPS/eip-721">ERC-721 standard</a> which allows for minting multiple tokens for close to the gas cost of minting a single token.</p>

<h3 id="frontend">Frontend</h3>

<p>We had 3 goals for our frontend:</p>

<ul>
  <li>Offer a unique thematic design</li>
  <li>Provide information and context about the project</li>
  <li>Allow users to easily mint the token</li>
</ul>

<p>We went with simple layout which emphasises the NFT and clearly communicates the projectâ€™s purpose. The <code class="language-plaintext highlighter-rouge">Solar Mono</code> typeface was chosen for its clean and minimalistic look and really ties the design together. RainbowKitâ€™s theme customization was used to change the type to match the rest of the design to ensure a consistent look and feel.</p>

<p>The site was designed using Figma before being implemented using the React framework in TypeScript. <a href="https://wagmi.sh">wagmi.sh</a> was used to interact with the contract and mint the tokens. <a href="https://github.com/wighawag/hardhat-deploy">Hardhat Deploy</a> is used in the backend to export a JSON file containing the contract addresses and ABIs which is used by the frontend to interact with the contract. In order to support typing for the contract ABI, we used a workaround from this <a href="https://github.com/microsoft/TypeScript/issues/32063#issuecomment-819025995">issue</a> on the TypeScript repo. I turned it into <code class="language-plaintext highlighter-rouge">prestart</code> script in the <code class="language-plaintext highlighter-rouge">package.json</code> file which converts the <code class="language-plaintext highlighter-rouge">deployments.json</code> generated by Hardhat Deploy into a <code class="language-plaintext highlighter-rouge">.ts</code> file:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"prestart"</span><span class="p">:</span><span class="w"> </span><span class="s2">"echo </span><span class="se">\"</span><span class="s2">declare const schema: $(cat src/deployments.json); export default schema;</span><span class="se">\"</span><span class="s2"> &gt; src/deployments.json.d.ts"</span><span class="w">
</span></code></pre></div></div>

<p>The mint button which supports minting multiple tokens at once was the most interesting design challenge. We had designed a similar input for <a href="https://offset.onsetcarbon.com">Onset Carbonâ€™s storefront</a> which we were planning to reuse but it didnâ€™t quite fit the design of the rest of the site as it was too complex. We ended up placing the mint button inbetween a decrement and increment button while displaying the number of tokens to be minted along with the total price inside the button. This was a simple solution which worked well because it doesnâ€™t strain the userâ€™s attention too much and was easy to implement.</p>

<p>While trying to think of a way to make the site more interactive we decided to add some sounds. Each button interaction has a sound effect which is played when it is pressed. The increment and decrement buttons change pitch when pressed to give the user a sense of progression. The mint button has a sound effect which is played when the user presses it and is prompted to sign with their wallet and finally a whimsical effect is played when the transaction is confirmed.</p>

<iframe width="420" height="315" src="https://www.youtube.com/embed/kMvmt_FZQHs" frameborder="0" allowfullscreen=""></iframe>
<p><em>Minting demo</em></p>

<h2 id="deployment">Deployment</h2>

<p>After testing on Goerli and ensuring that everything works properly (rendering, OpenSea support, attributes, etc.), we waited for a time that the <code class="language-plaintext highlighter-rouge">hardhat-gas-reporter</code> plugin reported that the gas cost of deployment would be reasonable and deployed to mainnet.</p>

<p>The frontend is hosted on GitHub pages by following the React deployment guide and linked to our custom domain https://onchainsolar.systems.</p>

<h2 id="mint">Mint</h2>

<p>Minting was open as soon as we launched the project, but we airdropped 10 tokens to Luke and myself before announcing it publicly. I shared the project on <a href="https://www.discove.xyz/casts/0x4cebfd2b23f82a480d02199e4485d6113f9a34c43e52b0129636cfc1d2cbb0a1">Farcaster</a> followed by <a href="https://twitter.com/stephancill/status/1608491031875526656">Twitter</a>.</p>

<p>We had low expectations to begin with. I even suggested that we should decrease the total supply to 100 tokens to make it more exclusive because I never imagined that we would sell out.</p>

<p><img src="/assets/solar-systems/never-minting-1000.jpg" alt="Chat screenshot" />
<em>Aged like milk</em></p>

<p>After 1 hour we had sold about 10 tokens but suddenly the sales started to pick up. After the first 20 or so sales in the first hour we were getting 100 or so sales per minute and next thing we knew we had sold out. It was a surreal experience and something I will never forget. The next 24 hours was followed by trending at #5 on OpenSea and $120k in trading volume which is something I never expected in my wildest dreams.</p>

<h3 id="refunds">Refunds</h3>

<p>After the mint I received a message from someone that had only received 1 token instead of the amount that they had paid for. This was a strange issue that must have been caused by manually increasing the value sent to the contract after initiating the mint transaction on our website. I refunded the user and wrote a <a href="https://github.com/lbowles/solar-systems/blob/main/backend/analytics/findRefundTx.ts">script</a> to find any other users who had this issue and fortunately only found 2 other instances and refunded them as well. In future contracts we will be sure to implement automatic refunding to prevent this issue from happening again.</p>

<h2 id="conclusion">Conclusion</h2>

<p>We were encouraged to learn that there is such a strong demand for on-chain NFTs and hope to do (and see) more projects like this in the future. Seeing as Solar Systems was our first successful project, we would like to reward those that supported us with early access to our next project so please follow us on Twitter <a href="https://twitter.com/stephancill">@stephancill</a>, <a href="https://twitter.com/npm_luko">@npm_luko</a>, <a href="https://twitter.com/SolarSystemsNFT">@SolarSystemsNFT</a> to stay up to date with the latest announcements.</p>

<p>ðŸ”­ðŸŒŒ</p>

<h2 id="resources">Resources</h2>

<p><a href="https://onchainsolar.systems">Website</a></p>

<p><a href="https://github.com/lbowles/solar-systems">Source</a></p>]]></content><author><name></name></author><category term="projects" /><summary type="html"><![CDATA[On-chain Solar Systems]]></summary></entry></feed>